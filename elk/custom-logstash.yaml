logstashJavaOpts: "-Xmx256m -Xms256m"

resources:
  requests:
    cpu: "100m"
    memory: "1Gi"
  limits:
    cpu: "1000m"
    memory: "1Gi"

volumeClaimTemplate:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn-storage-delete
  resources:
    requests:
      storage: 512Mi

antiAffinity: "soft"

extraEnvs: 
  - name: xpack.monitoring.enabled
    value: "false"

service:
  type: ClusterIP
  ports:
    - name: beats
      port: 5044
      protocol: TCP
      targetPort: 5044
    - name: http
      port: 9600
      protocol: TCP
      targetPort: 9600

logstashPipeline:
  logstash.conf: |
    input {
        beats {
            port => "5044"
        }
    }
    filter {
        mutate {
            add_field => { 
              "environment" => "production",
              "received_at" => "%{@timestamp}"
            }
        }
        
        if "frontend" in [tags] {
            grok {
              match => {
                "message" => "%{YEAR:message.year}/%{MONTHNUM:message.month}/%{MONTHDAY:message.day} %{TIME:message.time} \[%{WORD:message.loglevel}\] %{NUMBER:message.pid}#%{NUMBER:message.worker}: %{GREEDYDATA:message.main_message}"
              }
            }
          } else if "backend" in [tags] or "notification-service" in [tags] {
            grok {
              match => { 
                "message" => "%{TIMESTAMP_ISO8601:message.timestamp}\s+%{LOGLEVEL:message.loglevel} %{NUMBER:message.pid} --- \[%{DATA:message.service}\] \[\s+%{DATA:message.thread}\] %{DATA:message.class}\s+:\s+%{GREEDYDATA:message.main_message}" 
              }
            }
          } else if "rabbitmq" in [tags] {
            grok {
              match => {
                "message" => "%{TIMESTAMP_ISO8601:message.timestamp} \[%{WORD:message.loglevel}\] <%{DATA:message.pid}> %{GREEDYDATA:message.main_message}"
              }
            }
          } else if "mysql" in [tags] {
            grok {
              match => {
                "message" => "%{TIMESTAMP_ISO8601:message.timestamp} %{NUMBER:message.pid} \[%{WORD:message.loglevel}\] \[%{DATA:message.code}\] \[%{WORD:message.component}\] %{GREEDYDATA:message.main_message}"
              }
            }
          }
        
        if [message.timestamp] {
            date {
              match => [ "message.timestamp", "ISO8601" ]
            }
          }
    }
    output {
      if "myopensource" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myopensource_%{tags[1]}_%{+YYYY.MM.dd}"
          }
      }
      else if "myservice" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myservice_%{tags[1]}_%{+YYYY.MM.dd}"
          }
      }
      else {
        elasticsearch {
          hosts => [ "elasticsearch-master:9200" ]
          index => "default_%{+YYYY.MM.dd}"
         }
      }
    }