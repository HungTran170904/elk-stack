logstashJavaOpts: "-Xmx256m -Xms256m"

resources:
  requests:
    cpu: "100m"
    memory: "1Gi"
  limits:
    cpu: "1000m"
    memory: "1Gi"

volumeClaimTemplate:
  accessModes: ["ReadWriteOnce"]
  storageClassName: longhorn-storage-delete
  resources:
    requests:
      storage: 512Mi

antiAffinity: "soft"

extraEnvs: 
  - name: xpack.monitoring.enabled
    value: "false"

service:
  type: ClusterIP
  ports:
    - name: beats
      port: 5044
      protocol: TCP
      targetPort: 5044
    - name: http
      port: 9600
      protocol: TCP
      targetPort: 9600

logstashPipeline:
  logstash.conf: |
    input {
        beats {
            port => "5044"
        }
    }
    filter {
        mutate {
            add_field => { 
              "received_at" => "%{@timestamp}" 
              "environment" => "production"
            }
        }
        if "backend" in [tags] or "notification-service" in [tags] {
           grok {
            match => { 
              "message" => 
                "%{TIMESTAMP_ISO8601:timestamp}\s+%{LOGLEVEL:loglevel} %{NUMBER:pid} --- \[%{DATA:service}\] \[\s+%{DATA:thread}\] %{DATA:class}\s+:\s+%{GREEDYDATA:main_message}" 
            }
          }
          date {
            match => [ "log_timestamp", "ISO8601" ]
          }
        }
    }
    output {
      stdout { codec => rubydebug }
      if "myopensource" in [tags] {
        if "mysql" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myopensource_mysql_%{+YYYY.MM.dd}"
          }
        }
        else if "rabbitmq" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myopensource_rabbitmq_%{+YYYY.MM.dd}"
          }
        }
      }
      else if "myservice" in [tags] {
        if "frontend" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myservice_frontend_%{+YYYY.MM.dd}"
          }
        }
        else if "backend" in [tags] {
          elasticsearch {
            hosts => [ "elasticsearch-master:9200" ]
            index => "myservice_backend_%{+YYYY.MM.dd}"
          }
        }
        else if "notification-service" in [tags]{
            elasticsearch {
                hosts => [ "elasticsearch-master:9200" ]
                index => "myservice_notification_service_%{+YYYY.MM.dd}"
            }
        }
      }
      else if "kubeservice" in [tags] {
        elasticsearch {
          hosts => [ "elasticsearch-master:9200" ]
          index => "kubeservice_%{+YYYY.MM.dd}"
         }
      }
      else {
        elasticsearch {
          hosts => [ "elasticsearch-master:9200" ]
          index => "default_%{+YYYY.MM.dd}"
         }
      }
    }